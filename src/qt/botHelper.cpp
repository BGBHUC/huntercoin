#include "util.h"
#include "bot.h"
#include <stdio.h>
#include <string>
#include <iostream>
#include <fstream>
#include "../gamemap.h"
#include "../gamestate.h"
#include "gamemovecreator.h"
#include <boost/foreach.hpp>
#include <boost/xpressive/xpressive_dynamic.hpp>
#include <boost/assign/list_of.hpp>
#include <boost/algorithm/string.hpp>

Game::Coord BotHelper::getEmptyCoinCoord(const Game::GameState &gameState,const Game::Coord &coord,int within) {
	std::vector<Game::Coord> coords;
    for (int i = 0; i < Game::NUM_HARVEST_AREAS; i++)   {
    	for (int a = 0; a < Game::HarvestAreaSizes[i]; a++) {
    		Game::Coord harvest(Game::HarvestAreas[i][2 * a], Game::HarvestAreas[i][2 * a + 1]);
    		if (BotHelper::getDistance(harvest,coord) <= within && BotHelper::isEmpty(harvest,gameState)) {
    			coords.push_back(harvest);
    		}
    	}
    }
    if (coords.size() > 0) {
    	return coords[rand() % coords.size()];
    }
    return Game::Coord(-1,-1);
}
bool BotHelper::isEmpty(const Game::Coord &coord,const Game::GameState &gameState) {
	BOOST_FOREACH(const PAIRTYPE(Game::PlayerID, Game::PlayerState) &p, gameState.players) {
		BOOST_FOREACH(const PAIRTYPE(int, Game::CharacterState) &pc, p.second.characters) {
		   if (pc.second.coord == coord && pc.second.waypoints.empty()) {
			   return false;
		   }
	   }
	}
	return true;
}
bool BotHelper::isAlone(const BotState &botState,const Game::GameState &gameState) {
	BOOST_FOREACH(const PAIRTYPE(Game::PlayerID, Game::PlayerState) &p, gameState.players) {
		if (p.first == botState.name) continue;
		BOOST_FOREACH(const PAIRTYPE(int, Game::CharacterState) &pc, p.second.characters) {
		   if (pc.second.coord == botState.state.coord && pc.second.waypoints.empty()) {
			   return false;
		   }
	   }
	}
	return true;
}
unsigned BotHelper::getTime(Game::Coord to,Game::Coord from) {
	std::vector<Game::Coord> wps = FindPath(to,from);
	if (wps.empty()) {
		return 999;
	}
	unsigned res = 0;
	Game::Coord last = wps[0];
	for (int i = 1; i < wps.size(); i++) {
		res += std::max(abs(wps[i].x - last.x), abs(wps[i].y - last.y));
		last = wps[i];
	}
	return res;
}
std::string BotHelper::to_string(int number) {
    std::string number_string = "";
    char ones_char;
    int ones = 0;
    while(true){
        ones = number % 10;
        switch(ones){
            case 0: ones_char = '0'; break;
            case 1: ones_char = '1'; break;
            case 2: ones_char = '2'; break;
            case 3: ones_char = '3'; break;
            case 4: ones_char = '4'; break;
            case 5: ones_char = '5'; break;
            case 6: ones_char = '6'; break;
            case 7: ones_char = '7'; break;
            case 8: ones_char = '8'; break;
            case 9: ones_char = '9'; break;
            //default : ErrorHandling("Trouble converting number to string.");
        }
        number -= ones;
        number_string = ones_char + number_string;
        if(number == 0){
            break;
        }
        number = number/10;
    }
    return number_string;
}
std::string BotHelper::coordToString(Game::Coord coord) {
	return BotHelper::to_string(coord.x)+"-"+BotHelper::to_string(coord.y);
}

BotTarget BotHelper::getClosestLoot(const Game::GameState &gameState,const BotState &botState,std::map<std::string,BotTarget> &myTargets,double within) {
	BotTarget target;
	BOOST_FOREACH(const PAIRTYPE(Game::Coord, Game::LootInfo) &p, gameState.loot)    {
		std::string testName = "!LOOT "+BotHelper::coordToString(p.first);
		double measured = BotHelper::getDistance(p.first,botState.state.coord);
		if (measured < within) {
			if (myTargets.find(testName) == myTargets.end()) {
				printf("LOOT TARGET FOUND -- ");
				within = measured;
				target.targetName = testName;
				target.targetIndex = 0;
				target.coord = p.first;
				target.value = p.second.nAmount;
				target.block = gameState.nHeight;
				target.hunterName = botState.name;
				target.hunterIndex = botState.index;
				target.removeNextBlock = false;
			} else {
				printf("LOOT ALREADY TARGTED BY %s.%d --",myTargets[testName].hunterName.c_str(),myTargets[testName].hunterIndex);
			}
		}
	}
	return target;
}
bool BotHelper::isLootAt(const Game::GameState &gameState,const Game::Coord &coord) {
	BOOST_FOREACH(const PAIRTYPE(Game::Coord, Game::LootInfo) &p, gameState.loot)    {
		if (p.first == coord) {
			return true;
		}
	}
	return false;
}
bool BotHelper::coordIsSpawn(Game::Coord pos) {
	return pos.x == 0 || pos.x == 501 || pos.y == 0 || pos.y == 501;
}
double BotHelper::getLinear(int i) {
	return sqrt((i*i)+(i*i));
}
Game::Coord BotHelper::getClosestHome(unsigned color,Game::Coord from) {
	if (BotHelper::getDistance(Game::Coord(0,0),from) < 20) {
		color = 0;
	} else if (BotHelper::getDistance(Game::Coord(501,0),from) < 20) {
		color = 1;
	} else if (BotHelper::getDistance(Game::Coord(501,501),from) < 20) {
		color = 2;
	} else if (BotHelper::getDistance(Game::Coord(0,501),from) < 20) {
		color = 3;
	}
	std::vector<Game::Coord> spawnPoints;
	if (color == 0) {
		for (int y = 0; y <= 14; y++) {spawnPoints.push_back(Game::Coord(0,y));}
		for (int x = 0; x <= 14; x++) {spawnPoints.push_back(Game::Coord(x,0));}
	} else if (color == 1) {
		for (int y = 0; y <= 14; y++) {spawnPoints.push_back(Game::Coord(501,y));}
		for (int x = 0; x <= 14; x++) {spawnPoints.push_back(Game::Coord(501-x,0));}
	} else if (color == 2) {
		for (int y = 0; y <= 14; y++) {spawnPoints.push_back(Game::Coord(501,501-y));}
		for (int x = 0; x <= 14; x++) {spawnPoints.push_back(Game::Coord(501-x,501));}
	} else if (color == 3) {
		for (int y = 0; y <= 14; y++) {spawnPoints.push_back(Game::Coord(0,501-y));}
		for (int x = 0; x <= 14; x++) {spawnPoints.push_back(Game::Coord(x,501));}
	}
	Game::Coord shortestCoord;
	double measured = 500;
	for (int i = 0; i < spawnPoints.size(); i++) {
		double distance = BotHelper::getDistance(spawnPoints[i],from);
		if (distance < measured) {
			measured = distance;
			shortestCoord = spawnPoints[i];
		}
	}
	if (measured > 20) {
		if (rand() % 2) {
			switch (color) {
				case 0 : shortestCoord = Game::Coord(rand() % 14,0);break;
				case 1 : shortestCoord = Game::Coord(501,rand() % 14);break;
				case 2 : shortestCoord = Game::Coord(501-rand() % 14,501);break;
				case 3 : shortestCoord = Game::Coord(rand() % 14,501);break;
			}
		} else {
			switch (color) {
				case 0 : shortestCoord = Game::Coord(0,rand() % 14);break;
				case 1 : shortestCoord = Game::Coord(501-rand() % 14,0);break;
				case 2 : shortestCoord = Game::Coord(501,501-rand() % 14);break;
				case 3 : shortestCoord = Game::Coord(0,501-rand() % 14);break;
			}
		}
	}
	return shortestCoord;
}

double BotHelper::getDistance(Game::Coord to,Game::Coord from) {
	double result = sqrt((to.x-from.x)*(to.x-from.x) + (to.y-from.y)*(to.y-from.y));
	return result;
}
BotConfig BotHelper::getConfig() {
	BotConfig config = BotConfig();
	std::ifstream infile("botConf.txt");
	if (infile.good()) {
		for( std::string line; getline( infile, line ); ) {
			if (line.substr(0,1) == "#") continue;
			if (line.find("destb=") != std::string::npos || line.find("destg=") != std::string::npos || line.find("destr=") != std::string::npos || line.find("desty=") != std::string::npos || line.find("destx=") != std::string::npos) {
				std::string subStr1 = line.substr(6);
				std::vector<std::string> coords;
				boost::split(coords, subStr1, boost::is_any_of(" "));
				config.names.push_back(coords[0]);
				if (line.find("destb=") != std::string::npos) {
					config.colors.push_back(3);
				} else if (line.find("destr=") != std::string::npos) {
					config.colors.push_back(1);
				} else if (line.find("desty=") != std::string::npos) {
					config.colors.push_back(0);
				} else if (line.find("destg=") != std::string::npos) {
					config.colors.push_back(2);
				} else {
					config.colors.push_back(config.color);
				}
				std::vector<Game::Coord> points;
				for (int i = 1; i < coords.size(); i++) {
					std::vector<std::string> point;
					boost::split(point, coords[i] , boost::is_any_of(","));
					points.push_back(Game::Coord(atoi(point[0]),atoi(point[1])));
				}
				config.dests.push_back(points);
			} else if (line.find("debug=") != std::string::npos) {
				config.debug = atoi(line.substr(6));
				printf("debug=%d\n",config.debug);
			} else if (line.find("enabled=") != std::string::npos) {
				config.enabled = atoi(line.substr(8));
				printf("enabled=%d\n",config.enabled);
			} else if (line.find("mode=") != std::string::npos) {
				config.mode = line.substr(5);
				printf("mode=%s\n",config.mode.c_str());
			} else if (line.find("maxLoot=") != std::string::npos) {
				config.maxLoot = atoi64(line.substr(8));
				printf("maxLoot=%s\n",FormatMoney(config.maxLoot).c_str());
			} else if (line.find("startBlock=") != std::string::npos) {
				config.startBlock = atoi(line.substr(11));
				printf("startBlock=%d\n",config.startBlock);
			} else if (line.find("startDelay=") != std::string::npos) {
				config.startDelay = atoi(line.substr(11));
				printf("startDelay=%d\n",config.startDelay);
			} else if (line.find("maxLootDistanceAtDest=") != std::string::npos) {
				config.maxLootDistanceAtDest = atoi(line.substr(22));
				printf("maxLootDistanceAtDest=%d\n",config.maxLootDistanceAtDest);
			} else if (line.find("maxLootDistanceInRoute=") != std::string::npos) {
				config.maxLootDistanceInRoute = atoi(line.substr(23));
				printf("maxLootDistanceInRoute=%d\n",config.maxLootDistanceInRoute);
			} else if (line.find("transfer=") != std::string::npos) {
				config.transfer = line.substr(9);
				printf("transfer=%s\n",config.transfer.c_str());
			} else if (line.find("maxBorn=") != std::string::npos) {
				config.maxBorn = atoi(line.substr(8));
				printf("maxBorn=%d\n",config.maxBorn);
			} else if (line.find("maxCreate=") != std::string::npos) {
				config.maxCreate = atoi(line.substr(10));
				printf("maxCreate=%d\n",config.maxCreate);
			} else if (line.find("createOnBlock=") != std::string::npos) {
				config.createOnBlock = atoi(line.substr(14));
				printf("createOnBlock=%d\n",config.createOnBlock);
			} else if (line.find("minCreateBalance=") != std::string::npos) {
				config.minCreateBalance = atoi64(line.substr(17));
				printf("minCreateBalance=%s\n",FormatMoney(config.minCreateBalance).c_str());
			} else if (line.find("stickToDest=") != std::string::npos) {
				config.stickToDest = atoi(line.substr(12));
				printf("stickToDest=%d\n",config.stickToDest);
			} else if (line.find("maxMaxLoot=") != std::string::npos) {
				config.maxMaxLoot = atoi(line.substr(11));
				printf("maxMaxLoot=%d\n",config.maxMaxLoot);
			} else if (line.find("maxMoves=") != std::string::npos) {
				config.maxMoves = atoi(line.substr(9));
				printf("maxMoves=%d\n",config.maxMoves);
			}
		}
		infile.close();
	}
	return config;
}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
